name: Build and Release Binaries

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            extension: ""
          - os: macos-latest
            extension: ""
          - os: windows-latest
            extension: ".exe"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build easydots
        uses: Nuitka/Nuitka-Action@main
        with:
          script-name: easydots.py
          onefile: true
          standalone: true
          output-dir: build

      - name: Build easyscripts
        uses: Nuitka/Nuitka-Action@main
        with:
          script-name: easyscripts.py
          onefile: true
          standalone: true
          output-dir: build

      - name: Create compressed archives
        shell: bash
        run: |
          mkdir -p dist
          for script in easydots easyscripts; do
            tar -cJf "dist/${script}-${{ matrix.os }}.tar.xz" -C build "${script}${{ matrix.extension }}"
          done

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
